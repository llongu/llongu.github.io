<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1. 文件上传的几种方式 | 写字の地方</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="logo.png" with="0.1rem" search="true">
    <script src="https://hm.baidu.com/hm.js?9fe3e108f82a020dfa7c0120f577c7db"></script>
    <script src="/js/main.js"></script>
    <meta name="description" content="notes">
    
    <link rel="preload" href="/assets/css/0.styles.01960845.css" as="style"><link rel="preload" href="/assets/js/app.e6819fdb.js" as="script"><link rel="preload" href="/assets/js/2.1d159e52.js" as="script"><link rel="preload" href="/assets/js/108.b6d436c2.js" as="script"><link rel="prefetch" href="/assets/js/10.89a37be0.js"><link rel="prefetch" href="/assets/js/100.c4a56307.js"><link rel="prefetch" href="/assets/js/101.3475447a.js"><link rel="prefetch" href="/assets/js/102.257e911d.js"><link rel="prefetch" href="/assets/js/103.f83da7a8.js"><link rel="prefetch" href="/assets/js/104.87ebc28c.js"><link rel="prefetch" href="/assets/js/105.17d2a1ac.js"><link rel="prefetch" href="/assets/js/106.0de01832.js"><link rel="prefetch" href="/assets/js/107.49a4eac7.js"><link rel="prefetch" href="/assets/js/109.02f26509.js"><link rel="prefetch" href="/assets/js/11.21872ed2.js"><link rel="prefetch" href="/assets/js/110.18915e9a.js"><link rel="prefetch" href="/assets/js/111.1df205ef.js"><link rel="prefetch" href="/assets/js/112.9beb9d8c.js"><link rel="prefetch" href="/assets/js/113.b4ec8ab4.js"><link rel="prefetch" href="/assets/js/114.9420d135.js"><link rel="prefetch" href="/assets/js/115.4ebc0232.js"><link rel="prefetch" href="/assets/js/116.629827bc.js"><link rel="prefetch" href="/assets/js/117.a3ea69bc.js"><link rel="prefetch" href="/assets/js/118.6f5496f8.js"><link rel="prefetch" href="/assets/js/119.dee75cb3.js"><link rel="prefetch" href="/assets/js/12.f3cda581.js"><link rel="prefetch" href="/assets/js/120.c9dd5eaa.js"><link rel="prefetch" href="/assets/js/13.64e41ebe.js"><link rel="prefetch" href="/assets/js/14.1f516900.js"><link rel="prefetch" href="/assets/js/15.9982eeb0.js"><link rel="prefetch" href="/assets/js/16.5e3eb424.js"><link rel="prefetch" href="/assets/js/17.b39cce75.js"><link rel="prefetch" href="/assets/js/18.e4fad0d3.js"><link rel="prefetch" href="/assets/js/19.baca13cf.js"><link rel="prefetch" href="/assets/js/20.05e9f109.js"><link rel="prefetch" href="/assets/js/21.06259bb4.js"><link rel="prefetch" href="/assets/js/22.29c16c77.js"><link rel="prefetch" href="/assets/js/23.da9fdcb4.js"><link rel="prefetch" href="/assets/js/24.4e1542af.js"><link rel="prefetch" href="/assets/js/25.ebe8e6ac.js"><link rel="prefetch" href="/assets/js/26.79d54e3b.js"><link rel="prefetch" href="/assets/js/27.42a77246.js"><link rel="prefetch" href="/assets/js/28.4a663f36.js"><link rel="prefetch" href="/assets/js/29.28d0b857.js"><link rel="prefetch" href="/assets/js/3.0360a2cf.js"><link rel="prefetch" href="/assets/js/30.11dfcaaf.js"><link rel="prefetch" href="/assets/js/31.dcb8c8c6.js"><link rel="prefetch" href="/assets/js/32.ab88ea49.js"><link rel="prefetch" href="/assets/js/33.9af4940a.js"><link rel="prefetch" href="/assets/js/34.bcf1fa48.js"><link rel="prefetch" href="/assets/js/35.300f0c10.js"><link rel="prefetch" href="/assets/js/36.ffe4c220.js"><link rel="prefetch" href="/assets/js/37.7ed320db.js"><link rel="prefetch" href="/assets/js/38.0767926b.js"><link rel="prefetch" href="/assets/js/39.a7ad8542.js"><link rel="prefetch" href="/assets/js/4.354a9c3b.js"><link rel="prefetch" href="/assets/js/40.72ee9be2.js"><link rel="prefetch" href="/assets/js/41.21924a1b.js"><link rel="prefetch" href="/assets/js/42.7bfbc45d.js"><link rel="prefetch" href="/assets/js/43.06221f60.js"><link rel="prefetch" href="/assets/js/44.0b167734.js"><link rel="prefetch" href="/assets/js/45.79a5c4f1.js"><link rel="prefetch" href="/assets/js/46.02cdcff2.js"><link rel="prefetch" href="/assets/js/47.f59b9df5.js"><link rel="prefetch" href="/assets/js/48.5eb30c09.js"><link rel="prefetch" href="/assets/js/49.2a591682.js"><link rel="prefetch" href="/assets/js/5.ff2d80a7.js"><link rel="prefetch" href="/assets/js/50.7888d431.js"><link rel="prefetch" href="/assets/js/51.09e85d4d.js"><link rel="prefetch" href="/assets/js/52.822f2816.js"><link rel="prefetch" href="/assets/js/53.c224f6bb.js"><link rel="prefetch" href="/assets/js/54.b2f4652d.js"><link rel="prefetch" href="/assets/js/55.fcf20d5b.js"><link rel="prefetch" href="/assets/js/56.0ab045eb.js"><link rel="prefetch" href="/assets/js/57.9fc15dd8.js"><link rel="prefetch" href="/assets/js/58.826cd5cf.js"><link rel="prefetch" href="/assets/js/59.5d14f250.js"><link rel="prefetch" href="/assets/js/6.24e59b68.js"><link rel="prefetch" href="/assets/js/60.08c518f1.js"><link rel="prefetch" href="/assets/js/61.38b7886b.js"><link rel="prefetch" href="/assets/js/62.91124639.js"><link rel="prefetch" href="/assets/js/63.7b38f16b.js"><link rel="prefetch" href="/assets/js/64.3d4f3a1e.js"><link rel="prefetch" href="/assets/js/65.92f48d72.js"><link rel="prefetch" href="/assets/js/66.91fedd08.js"><link rel="prefetch" href="/assets/js/67.bf8b3ba2.js"><link rel="prefetch" href="/assets/js/68.588a5527.js"><link rel="prefetch" href="/assets/js/69.1ecfa2c8.js"><link rel="prefetch" href="/assets/js/7.defa4d7d.js"><link rel="prefetch" href="/assets/js/70.0903a441.js"><link rel="prefetch" href="/assets/js/71.c4743fa8.js"><link rel="prefetch" href="/assets/js/72.acc7a8da.js"><link rel="prefetch" href="/assets/js/73.ce9107cf.js"><link rel="prefetch" href="/assets/js/74.5bcd8261.js"><link rel="prefetch" href="/assets/js/75.77e11285.js"><link rel="prefetch" href="/assets/js/76.28264cd1.js"><link rel="prefetch" href="/assets/js/77.3b0ce223.js"><link rel="prefetch" href="/assets/js/78.f6d4e37d.js"><link rel="prefetch" href="/assets/js/79.2cba5405.js"><link rel="prefetch" href="/assets/js/8.27e8cfc8.js"><link rel="prefetch" href="/assets/js/80.ec80bc31.js"><link rel="prefetch" href="/assets/js/81.cfb34dbe.js"><link rel="prefetch" href="/assets/js/82.595f2f98.js"><link rel="prefetch" href="/assets/js/83.e218ee92.js"><link rel="prefetch" href="/assets/js/84.92d5baf4.js"><link rel="prefetch" href="/assets/js/85.0f551a9a.js"><link rel="prefetch" href="/assets/js/86.2b62e3d3.js"><link rel="prefetch" href="/assets/js/87.7df1bba3.js"><link rel="prefetch" href="/assets/js/88.a3dd71f1.js"><link rel="prefetch" href="/assets/js/89.fbef9cb6.js"><link rel="prefetch" href="/assets/js/9.c86bc6fe.js"><link rel="prefetch" href="/assets/js/90.f3f469b7.js"><link rel="prefetch" href="/assets/js/91.9177f479.js"><link rel="prefetch" href="/assets/js/92.70db6389.js"><link rel="prefetch" href="/assets/js/93.f26ed1d9.js"><link rel="prefetch" href="/assets/js/94.71f151d4.js"><link rel="prefetch" href="/assets/js/95.a26b2a6d.js"><link rel="prefetch" href="/assets/js/96.5b236c6d.js"><link rel="prefetch" href="/assets/js/97.18213bbf.js"><link rel="prefetch" href="/assets/js/98.ce2b2662.js"><link rel="prefetch" href="/assets/js/99.96c52cf4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.01960845.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="logo.png" alt="写字の地方" class="logo"> <span class="site-name can-hide">写字の地方</span></a> <div class="links"><!----> <div class="user-settings"><a href="#" class="settings-button"><svg aria-hidden="true" data-prefix="fas" data-icon="cog" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fa-cog fa-w-16 settings-icon"><path fill="currentColor" d="M444.788 291.1l42.616 24.599c4.867 2.809 7.126 8.618 5.459 13.985-11.07 35.642-29.97 67.842-54.689 94.586a12.016 12.016 0 0 1-14.832 2.254l-42.584-24.595a191.577 191.577 0 0 1-60.759 35.13v49.182a12.01 12.01 0 0 1-9.377 11.718c-34.956 7.85-72.499 8.256-109.219.007-5.49-1.233-9.403-6.096-9.403-11.723v-49.184a191.555 191.555 0 0 1-60.759-35.13l-42.584 24.595a12.016 12.016 0 0 1-14.832-2.254c-24.718-26.744-43.619-58.944-54.689-94.586-1.667-5.366.592-11.175 5.459-13.985L67.212 291.1a193.48 193.48 0 0 1 0-70.199l-42.616-24.599c-4.867-2.809-7.126-8.618-5.459-13.985 11.07-35.642 29.97-67.842 54.689-94.586a12.016 12.016 0 0 1 14.832-2.254l42.584 24.595a191.577 191.577 0 0 1 60.759-35.13V25.759a12.01 12.01 0 0 1 9.377-11.718c34.956-7.85 72.499-8.256 109.219-.007 5.49 1.233 9.403 6.096 9.403 11.723v49.184a191.555 191.555 0 0 1 60.759 35.13l42.584-24.595a12.016 12.016 0 0 1 14.832 2.254c24.718 26.744 43.619 58.944 54.689 94.586 1.667 5.366-.592 11.175-5.459 13.985L444.788 220.9a193.485 193.485 0 0 1 0 70.2zM336 256c0-44.112-35.888-80-80-80s-80 35.888-80 80 35.888 80 80 80 80-35.888 80-80z"></path></svg></a> <div class="user-settings-menu" style="display:none;"><div class="theme-options"><!----> <ul class="color-theme-options"><li><a href="#" class="default-theme"></a></li> <li><a href="#" class="blue-theme"></a></li><li><a href="#" class="red-theme"></a></li><li><a href="#" class="purple-theme"></a></li></ul> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox"></div> <div class="ignore-themes-options toggle-option"><label for="ignore-themes-toggle">Ignore Other Themes?</label> <input id="ignore-themes-toggle" type="checkbox"></div> <!----></div></div></div> <!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习" class="dropdown-title"><span class="title">前端学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端学习" class="mobile-dropdown-title"><span class="title">前端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/javascript/this.html" class="nav-link">
  javaScript
</a></li><li class="dropdown-item"><!----> <a href="/pages/typescript/basic.html" class="nav-link">
  typeScript
</a></li><li class="dropdown-item"><!----> <a href="/pages/browser/httpCode.html" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/pages/Html&amp;Css/formattingContexts.html" class="nav-link">
  Html&amp;Css
</a></li><li class="dropdown-item"><!----> <a href="/pages/webpack/process.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/pages/vue/vue2.html" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/pages/vite/home.html" class="nav-link">
  vite
</a></li><li class="dropdown-item"><!----> <a href="/pages/wxMini/core.html" class="nav-link">
  微信小程序
</a></li><li class="dropdown-item"><!----> <a href="/pages/jquery/entry.html" class="nav-link">
  jquery剖析
</a></li><li class="dropdown-item"><!----> <a href="/pages/function/begin.html" class="nav-link">
  函数式编程
</a></li><li class="dropdown-item"><!----> <a href="/pages/coding/aop&amp;oop.html" class="nav-link">
  编程思想
</a></li><li class="dropdown-item"><!----> <a href="/pages/leetcode&amp;books/home.html" class="nav-link">
  leetcode&amp;books
</a></li><li class="dropdown-item"><!----> <a href="/pages/unit/home.html" class="nav-link">
  单元测试
</a></li><li class="dropdown-item"><!----> <a href="/pages/agorithms/tire.html" class="nav-link">
  常见算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用功能解决方案" class="dropdown-title"><span class="title">常用功能解决方案</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用功能解决方案" class="mobile-dropdown-title"><span class="title">常用功能解决方案</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/use/uploadFile.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  大文件上传
</a></li><li class="dropdown-item"><!----> <a href="/pages/use/excel.html" class="nav-link">
  导入导出excel
</a></li><li class="dropdown-item"><!----> <a href="/pages/use/waterMark.html" class="nav-link">
  页面水印添加
</a></li><li class="dropdown-item"><!----> <a href="https://docs.qq.com/doc/DVU1TWU1UYXdpWnln" target="_blank" rel="noopener noreferrer" class="nav-link external">
  uni-app 常见问题
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/pages/use/officeView.html" class="nav-link">
  网页office预览方案
</a></li><li class="dropdown-item"><!----> <a href="/pages/use/video.html" class="nav-link">
  网页视频播放方案
</a></li><li class="dropdown-item"><!----> <a href="/pages/use/adminAuth.html" class="nav-link">
  后台管理系统权限设计
</a></li><li class="dropdown-item"><!----> <a href="https://docs.qq.com/doc/DVUFwbFhXdWhmb1dv" target="_blank" rel="noopener noreferrer" class="nav-link external">
  项目mock
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/pages/use/fn.html" class="nav-link">
  前端开发常用方法复制
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记" class="mobile-dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/notes/developConfig.html" class="nav-link">
  前端开发电脑环境配置
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/projectSop.html" class="nav-link">
  前端项目搭建sop流程
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/nvm.html" class="nav-link">
  使用nvm 管理node版本
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/verdaccio.html" class="nav-link">
  verdaccio 搭建npm 环境
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/vuepress1.html" class="nav-link">
  vuepress1.x 博客搭建流程
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/githubSyncGitee.html" class="nav-link">
  github 自动同步 gitee
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/llongu/ci-jenkins-demo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  jenkins 搭建流程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/pages/notes/gitDown.html" class="nav-link">
  使用node下载git项目到本地
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/hash.html" class="nav-link">
  Hash/对称与非对称算法
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/eslint.html" class="nav-link">
  手写一个eslint
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="npm&amp;github" class="dropdown-title"><span class="title">npm&amp;github</span> <span class="arrow down"></span></button> <button type="button" aria-label="npm&amp;github" class="mobile-dropdown-title"><span class="title">npm&amp;github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          cli
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.npmjs.com/package/create-app-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  create-app-web
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://github.com/llongu/create-app-web-lib" target="_blank" rel="noopener noreferrer" class="nav-link external">
  create-app-web-lib
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          plugin
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.npmjs.com/package/floater-dom" target="_blank" rel="noopener noreferrer" class="nav-link external">
  floater-dom
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://github.com/llongu/drag-text-mergeBg" target="_blank" rel="noopener noreferrer" class="nav-link external">
  drag-text-mergeBg
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          project
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/H5Game/index.html" class="nav-link">
  H5Game
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="服务端" class="dropdown-title"><span class="title">服务端</span> <span class="arrow down"></span></button> <button type="button" aria-label="服务端" class="mobile-dropdown-title"><span class="title">服务端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/nginx/des.html" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/pages/linux/order.html" class="nav-link">
  linux
</a></li><li class="dropdown-item"><!----> <a href="/pages/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/pages/jenkins/" class="nav-link">
  jenkins
</a></li><li class="dropdown-item"><!----> <a href="/pages/php/base.html" class="nav-link">
  php
</a></li><li class="dropdown-item"><!----> <a href="/pages/java/" class="nav-link">
  java
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具&amp;软件" class="dropdown-title"><span class="title">工具&amp;软件</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具&amp;软件" class="mobile-dropdown-title"><span class="title">工具&amp;软件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/docmirror/dev-sidecar" target="_blank" rel="noopener noreferrer" class="nav-link external">
  dev-sidecar 环境加速工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.snipaste.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  snipaste 截图工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://kingfast.info/index.php/index/register/?yqi=63283" target="_blank" rel="noopener noreferrer" class="nav-link external">
  科学上网
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://fakeimg.pl/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网页占位图
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工作之外" class="dropdown-title"><span class="title">工作之外</span> <span class="arrow down"></span></button> <button type="button" aria-label="工作之外" class="mobile-dropdown-title"><span class="title">工作之外</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/pm/process.html" class="nav-link">
  产品经理
</a></li><li class="dropdown-item"><!----> <a href="/pages/ui/color.html" class="nav-link">
  UI设计
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  聚合类网站收集
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  外包网站收集
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  浏览器插件聚合
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  薅羊毛
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  互联网常见项目 erp crm 
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  致富道路
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  致富道路-炒股软件
</a></li></ul></div></div> <a href="https://github.com/llongu/llongu.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习" class="dropdown-title"><span class="title">前端学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端学习" class="mobile-dropdown-title"><span class="title">前端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/javascript/this.html" class="nav-link">
  javaScript
</a></li><li class="dropdown-item"><!----> <a href="/pages/typescript/basic.html" class="nav-link">
  typeScript
</a></li><li class="dropdown-item"><!----> <a href="/pages/browser/httpCode.html" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/pages/Html&amp;Css/formattingContexts.html" class="nav-link">
  Html&amp;Css
</a></li><li class="dropdown-item"><!----> <a href="/pages/webpack/process.html" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/pages/vue/vue2.html" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/pages/vite/home.html" class="nav-link">
  vite
</a></li><li class="dropdown-item"><!----> <a href="/pages/wxMini/core.html" class="nav-link">
  微信小程序
</a></li><li class="dropdown-item"><!----> <a href="/pages/jquery/entry.html" class="nav-link">
  jquery剖析
</a></li><li class="dropdown-item"><!----> <a href="/pages/function/begin.html" class="nav-link">
  函数式编程
</a></li><li class="dropdown-item"><!----> <a href="/pages/coding/aop&amp;oop.html" class="nav-link">
  编程思想
</a></li><li class="dropdown-item"><!----> <a href="/pages/leetcode&amp;books/home.html" class="nav-link">
  leetcode&amp;books
</a></li><li class="dropdown-item"><!----> <a href="/pages/unit/home.html" class="nav-link">
  单元测试
</a></li><li class="dropdown-item"><!----> <a href="/pages/agorithms/tire.html" class="nav-link">
  常见算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用功能解决方案" class="dropdown-title"><span class="title">常用功能解决方案</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用功能解决方案" class="mobile-dropdown-title"><span class="title">常用功能解决方案</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/use/uploadFile.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  大文件上传
</a></li><li class="dropdown-item"><!----> <a href="/pages/use/excel.html" class="nav-link">
  导入导出excel
</a></li><li class="dropdown-item"><!----> <a href="/pages/use/waterMark.html" class="nav-link">
  页面水印添加
</a></li><li class="dropdown-item"><!----> <a href="https://docs.qq.com/doc/DVU1TWU1UYXdpWnln" target="_blank" rel="noopener noreferrer" class="nav-link external">
  uni-app 常见问题
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/pages/use/officeView.html" class="nav-link">
  网页office预览方案
</a></li><li class="dropdown-item"><!----> <a href="/pages/use/video.html" class="nav-link">
  网页视频播放方案
</a></li><li class="dropdown-item"><!----> <a href="/pages/use/adminAuth.html" class="nav-link">
  后台管理系统权限设计
</a></li><li class="dropdown-item"><!----> <a href="https://docs.qq.com/doc/DVUFwbFhXdWhmb1dv" target="_blank" rel="noopener noreferrer" class="nav-link external">
  项目mock
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/pages/use/fn.html" class="nav-link">
  前端开发常用方法复制
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记" class="mobile-dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/notes/developConfig.html" class="nav-link">
  前端开发电脑环境配置
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/projectSop.html" class="nav-link">
  前端项目搭建sop流程
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/nvm.html" class="nav-link">
  使用nvm 管理node版本
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/verdaccio.html" class="nav-link">
  verdaccio 搭建npm 环境
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/vuepress1.html" class="nav-link">
  vuepress1.x 博客搭建流程
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/githubSyncGitee.html" class="nav-link">
  github 自动同步 gitee
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/llongu/ci-jenkins-demo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  jenkins 搭建流程
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/pages/notes/gitDown.html" class="nav-link">
  使用node下载git项目到本地
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/hash.html" class="nav-link">
  Hash/对称与非对称算法
</a></li><li class="dropdown-item"><!----> <a href="/pages/notes/eslint.html" class="nav-link">
  手写一个eslint
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="npm&amp;github" class="dropdown-title"><span class="title">npm&amp;github</span> <span class="arrow down"></span></button> <button type="button" aria-label="npm&amp;github" class="mobile-dropdown-title"><span class="title">npm&amp;github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          cli
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.npmjs.com/package/create-app-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  create-app-web
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://github.com/llongu/create-app-web-lib" target="_blank" rel="noopener noreferrer" class="nav-link external">
  create-app-web-lib
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          plugin
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.npmjs.com/package/floater-dom" target="_blank" rel="noopener noreferrer" class="nav-link external">
  floater-dom
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://github.com/llongu/drag-text-mergeBg" target="_blank" rel="noopener noreferrer" class="nav-link external">
  drag-text-mergeBg
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><h4>
          project
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/H5Game/index.html" class="nav-link">
  H5Game
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="服务端" class="dropdown-title"><span class="title">服务端</span> <span class="arrow down"></span></button> <button type="button" aria-label="服务端" class="mobile-dropdown-title"><span class="title">服务端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/nginx/des.html" class="nav-link">
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/pages/linux/order.html" class="nav-link">
  linux
</a></li><li class="dropdown-item"><!----> <a href="/pages/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/pages/jenkins/" class="nav-link">
  jenkins
</a></li><li class="dropdown-item"><!----> <a href="/pages/php/base.html" class="nav-link">
  php
</a></li><li class="dropdown-item"><!----> <a href="/pages/java/" class="nav-link">
  java
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具&amp;软件" class="dropdown-title"><span class="title">工具&amp;软件</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具&amp;软件" class="mobile-dropdown-title"><span class="title">工具&amp;软件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/docmirror/dev-sidecar" target="_blank" rel="noopener noreferrer" class="nav-link external">
  dev-sidecar 环境加速工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.snipaste.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  snipaste 截图工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://kingfast.info/index.php/index/register/?yqi=63283" target="_blank" rel="noopener noreferrer" class="nav-link external">
  科学上网
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://fakeimg.pl/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网页占位图
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工作之外" class="dropdown-title"><span class="title">工作之外</span> <span class="arrow down"></span></button> <button type="button" aria-label="工作之外" class="mobile-dropdown-title"><span class="title">工作之外</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/pm/process.html" class="nav-link">
  产品经理
</a></li><li class="dropdown-item"><!----> <a href="/pages/ui/color.html" class="nav-link">
  UI设计
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  聚合类网站收集
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  外包网站收集
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  浏览器插件聚合
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  薅羊毛
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  互联网常见项目 erp crm 
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  致富道路
</a></li><li class="dropdown-item"><!----> <a href="/pages/" class="nav-link router-link-active">
  致富道路-炒股软件
</a></li></ul></div></div> <a href="https://github.com/llongu/llongu.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/use/fn.html" class="sidebar-link">前端开发常用方法复制</a></li><li><a href="/pages/use/uploadFile.html" aria-current="page" class="active sidebar-link">前端文件上传方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_1-文件上传的几种方式" class="sidebar-link">1. 文件上传的几种方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#普通表单上传" class="sidebar-link">普通表单上传</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#文件编码上传" class="sidebar-link">文件编码上传</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#formdata-异步上传" class="sidebar-link">formData 异步上传</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#iframe-无刷新页面" class="sidebar-link">iframe 无刷新页面</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_2-大文件上传" class="sidebar-link">2. 大文件上传</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#文件切片" class="sidebar-link">文件切片</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#还原切片" class="sidebar-link">还原切片</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#断点续传" class="sidebar-link">断点续传</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#上传进度和暂停" class="sidebar-link">上传进度和暂停</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_3-第三方上传-阿里云上传实践" class="sidebar-link">3. 第三方上传-阿里云上传实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_3-1-开通-oss-服务-使用-sts-临时访问凭证访问-oss" class="sidebar-link">3.1 开通 oss 服务，使用 STS 临时访问凭证访问 OSS</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_3-2-普通上传-不支持使用进度函数-建议-100m-内使用-大文件会崩溃" class="sidebar-link">3.2 普通上传(不支持使用进度函数,建议 100M 内使用，大文件会崩溃)：</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_3-3-分片上传" class="sidebar-link">3.3 分片上传</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_4-第三方上传-又拍云上传实践" class="sidebar-link">4. 第三方上传-又拍云上传实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_4-1-创建-又拍云签名-以及上传路径信息" class="sidebar-link">4.1 创建 又拍云签名,以及上传路径信息</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_4-2-创建-原生-xhr-对象" class="sidebar-link">4.2 创建 原生 xhr 对象</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_4-3-文件分片-md5-加密" class="sidebar-link">4.3 文件分片，md5 加密</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_4-4-上传核心方法-uploader-类" class="sidebar-link">4.4 上传核心方法 uploader 类</a></li><li class="sidebar-sub-header"><a href="/pages/use/uploadFile.html#_4-5-调用方法" class="sidebar-link">4.5 调用方法</a></li></ul></li></ul></li><li><a href="/pages/use/excel.html" class="sidebar-link">导入导出excel</a></li><li><a href="/pages/use/waterMark.html" class="sidebar-link">页面水印添加</a></li><li><a href="/pages/use/officeView.html" class="sidebar-link">网页office预览方案</a></li><li><a href="/pages/use/video.html" class="sidebar-link">网页视频播放方案</a></li><li><a href="/pages/use/adminAuth.html" class="sidebar-link">后台管理系统权限管理</a></li><li><a href="/pages/use/wxsignature.html" class="sidebar-link">微信分享签名</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-文件上传的几种方式"><a href="#_1-文件上传的几种方式" class="header-anchor">#</a> 1. 文件上传的几种方式</h2> <p>首先我们来看看文件上传的几种方式。</p> <h3 id="普通表单上传"><a href="#普通表单上传" class="header-anchor">#</a> 普通表单上传</h3> <p>使用 PHP 来展示常规的表单上传是一个不错的选择。首先构建文件上传的表单，并指定表单的提交内容类型为<code>enctype=&quot;multipart/form-data&quot;</code>，表明表单需要上传二进制数据。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string">&quot;/index.php&quot;</span> method<span class="token operator">=</span><span class="token string">&quot;POST&quot;</span> enctype<span class="token operator">=</span><span class="token string">&quot;multipart/form-data&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;file&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;myfile&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;submit&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>

</code></pre></div><p>然后编写<code>index.php</code>上传文件接收代码，使用<code>move_uploaded_file</code>方法即可(php 大法好...)</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>$imgName <span class="token operator">=</span> <span class="token string">'IMG'</span><span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'.'</span><span class="token punctuation">.</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">'image/'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span>$_FILES<span class="token punctuation">[</span><span class="token string">&quot;myfile&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
$fileName <span class="token operator">=</span>  <span class="token string">'upload/'</span><span class="token punctuation">.</span>$imgName<span class="token punctuation">;</span>
<span class="token comment">// 移动上传文件至指定upload文件夹下，并根据返回值判断操作是否成功</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'myfile'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> $fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    echo $fileName<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    echo <span class="token string">&quot;nonn&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>form 表单上传大文件时，很容易遇见服务器超时的问题。通过 xhr，前端也可以进行异步上传文件的操作，一般由两个思路。</p> <h3 id="文件编码上传"><a href="#文件编码上传" class="header-anchor">#</a> 文件编码上传</h3> <p>第一个思路是将文件进行编码，然后在服务端进行解码，之前写过一篇<a href="https://link.juejin.im?target=%255Bhttps%3A%2F%2Fwww.shymean.com%2Farticle%2F%25E5%259C%25A8%25E5%2589%258D%25E7%25AB%25AF%25E5%25AE%259E%25E7%258E%25B0%25E5%259B%25BE%25E7%2589%2587%25E5%258E%258B%25E7%25BC%25A9%25E4%25B8%258A%25E4%25BC%25A0%255D(https%3A%2F%2Fwww.shymean.com%2Farticle%2F%25E5%259C%25A8%25E5%2589%258D%25E7%25AB%25AF%25E5%25AE%259E%25E7%258E%25B0%25E5%259B%25BE%25E7%2589%2587%25E5%258E%258B%25E7%25BC%25A9%25E4%25B8%258A%25E4%25BC%25A0)" target="_blank" rel="noopener noreferrer">在前端实现图片压缩上传<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的博客，其主要实现原理就是将图片转换成 base64 进行传递</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> imgURL <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>imgURL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取图片的编码，然后将图片当做是一个很长的字符串进行传递</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">&quot;image/jpeg&quot;</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在服务端需要做的事情也比较简单，首先解码 base64，然后保存图片即可</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>$imgData <span class="token operator">=</span> $_REQUEST<span class="token punctuation">[</span><span class="token string">&quot;imgData&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
$base64 <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> $imgData<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
$img <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span>$base64<span class="token punctuation">)</span><span class="token punctuation">;</span>
$url <span class="token operator">=</span> <span class="token string">&quot;./test.jpg&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_put_contents</span><span class="token punctuation">(</span>$url<span class="token punctuation">,</span> $img<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> $url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>base64 编码的缺点在于其体积比原图片更大（因为 Base64 将三个字节转化成四个字节，因此编码后的文本，会比原文本大出三分之一左右），对于体积很大的文件来说，上传和解析的时间会明显增加。</p> <p>更多关于 base64 的知识，可以参考<a href="https://link.juejin.im?target=%255Bhttp%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2008%2F06%2Fbase64.html%255D(http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2008%2F06%2Fbase64.html)" target="_blank" rel="noopener noreferrer">Base64 笔记<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>除了进行 base64 编码，还可以在前端直接读取文件内容后以二进制格式上传</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 读取二进制文件</span>
<span class="token keyword">function</span> <span class="token function">readBinary</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> ui8a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> text<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ui8a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ui8a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">readBinary</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取result或直接上传</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 把从input里读取的文件内容，放到fileReader的result字段里</span>
reader<span class="token punctuation">.</span><span class="token function">readAsBinaryString</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="formdata-异步上传"><a href="#formdata-异步上传" class="header-anchor">#</a> formData 异步上传</h3> <p><a href="https://link.juejin.im?target=https%3A%2F%2Fwww.shymean.com%2Farticle%2F(https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FFormData%2FUsing_FormData_Objects)" target="_blank" rel="noopener noreferrer">FormData<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>对象主要用来组装一组用 XMLHttpRequest 发送请求的键/值对，可以更加灵活地发送 Ajax 请求。可以使用 FormData 来模拟表单提交。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> files <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">;</span> <span class="token comment">// 获取input的file对象</span>
<span class="token keyword">let</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> formData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>服务端处理方式与直接 form 表单请求基本相同。</p> <h3 id="iframe-无刷新页面"><a href="#iframe-无刷新页面" class="header-anchor">#</a> iframe 无刷新页面</h3> <p>在低版本的浏览器（如 IE）上，xhr 是不支持直接上传 formdata 的，因此只能用 form 来上传文件，而 form 提交本身会进行页面跳转，这是因为 form 表单的<a href="https://link.juejin.im?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTML%2FElement%2Fform" target="_blank" rel="noopener noreferrer">target<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>属性导致的，其取值有</p> <ul><li>_self，默认值，在相同的窗口中打开响应页面</li> <li>_blank，在新窗口打开</li> <li>_parent，在父窗口打开</li> <li>_top，在最顶层的窗口打开</li> <li><code>framename</code>，在指定名字的 iframe 中打开</li></ul> <p>如果需要让用户体验异步上传文件的感觉，可以通过<code>framename</code>指定 iframe 来实现。把 form 的 target 属性设置为一个看不见的 iframe，那么返回的数据就会被这个 iframe 接受，因此只有该 iframe 会被刷新，至于返回结果，也可以通过解析这个 iframe 内的文本来获取。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> now <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token string">&quot;frame&quot;</span> <span class="token operator">+</span> now<span class="token punctuation">;</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;body&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;iframe style=&quot;display:none;&quot; name=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; id=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; /&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> $form <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#myForm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  $form
    <span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      action<span class="token operator">:</span> <span class="token string">&quot;/index.php&quot;</span><span class="token punctuation">,</span>
      method<span class="token operator">:</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span>
      enctype<span class="token operator">:</span> <span class="token string">&quot;multipart/form-data&quot;</span><span class="token punctuation">,</span>
      encoding<span class="token operator">:</span> <span class="token string">&quot;multipart/form-data&quot;</span><span class="token punctuation">,</span>
      target<span class="token operator">:</span> id<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;body&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-大文件上传"><a href="#_2-大文件上传" class="header-anchor">#</a> 2. 大文件上传</h2> <p>现在来看看在上面提到的几种上传方式中实现大文件上传会遇见的超时问题，</p> <ul><li>表单上传和 iframe 无刷新页面上传，实际上都是通过 form 标签进行上传文件，这种方式将整个请求完全交给浏览器处理，当上传大文件时，可能会遇见请求超时的情形</li> <li>通过 fromData，其实际也是在 xhr 中封装一组请求参数，用来模拟表单请求，无法避免大文件上传超时的问题</li> <li>编码上传，我们可以比较灵活地控制上传的内容</li></ul> <p>大文件上传最主要的问题就在于：<strong>在同一个请求中，要上传大量的数据，导致整个过程会比较漫长，且失败后需要重头开始上传</strong>。试想，如果我们将这个请求拆分成多个请求，每个请求的时间就会缩短，且如果某个请求失败，只需要重新发送这一次请求即可，无需从头开始，这样是否可以解决大文件上传的问题呢？</p> <p>综合上面的问题，看来大文件上传需要实现下面几个需求</p> <ul><li>支持拆分上传请求(即切片)</li> <li>支持断点续传</li> <li>支持显示上传进度和暂停上传</li></ul> <p>接下来让我们依次实现这些功能，看起来最主要的功能应该就是切片了。</p> <h3 id="文件切片"><a href="#文件切片" class="header-anchor">#</a> 文件切片</h3> <p>参考： <a href="https://link.juejin.im?target=https%3A%2F%2Fblog.csdn.net%2Fbaochao95%2Farticle%2Fdetails%2F52812876" target="_blank" rel="noopener noreferrer">大文件切割上传<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>编码方式上传中，在前端我们只要先获取文件的二进制内容，然后对其内容进行拆分，最后将每个切片上传到服务端即可。</p> <p>在 JavaScript 中，文件 FIle 对象是 Blob 对象的子类，Blob 对象包含一个重要的方法<code>slice</code>，通过这个方法，我们就可以对二进制文件进行拆分。</p> <p>下面是一个拆分文件的示例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">slice</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> piece <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">5</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> totalSize <span class="token operator">=</span> file<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token comment">// 文件总大小</span>
  <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 每次上传的开始字节</span>
  <span class="token keyword">let</span> end <span class="token operator">=</span> start <span class="token operator">+</span> piece<span class="token punctuation">;</span> <span class="token comment">// 每次上传的结尾字节</span>
  <span class="token keyword">let</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;</span> totalSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据长度截取每次需要上传的数据</span>
    <span class="token comment">// File对象继承自Blob对象，因此包含slice方法</span>
    <span class="token keyword">let</span> blob <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>

    start <span class="token operator">=</span> end<span class="token punctuation">;</span>
    end <span class="token operator">=</span> start <span class="token operator">+</span> piece<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> chunks<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>将文件拆分成<code>piece</code>大小的分块，然后每次请求只需要上传这一个部分的分块即可</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;[name=file]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">LENGTH</span> <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> chunks <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token constant">LENGTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 首先拆分切片</span>

chunks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/mkblk.php&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>服务器接收到这些切片后，再将他们拼接起来就可以了，下面是 PHP 拼接切片的示例代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>$filename <span class="token operator">=</span> <span class="token string">'./upload/'</span> <span class="token punctuation">.</span> $_POST<span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//确定上传的文件名</span>
<span class="token comment">//第一次上传时没有文件，就创建文件，此后上传只需要把数据追加到此文件中</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span>$filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>$filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span>$filename<span class="token punctuation">,</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">FILE_APPEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    echo $filename<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>测试时记得修改 nginx 的 server 配置，否则大文件可能会提示<code>413 Request Entity Too Large</code>的错误。</p> <div class="language- extra-class"><pre class="language-text"><code>server {
	// ...
	client_max_body_size 50m;
}

</code></pre></div><p>上面这种方式来存在一些问题</p> <ul><li>无法识别一个切片是属于哪一个切片的，当同时发生多个请求时，追加的文件内容会出错</li> <li>切片上传接口是异步的，无法保证服务器接收到的切片是按照请求顺序拼接的</li></ul> <p>因此接下来我们来看看应该如何在服务端还原切片。</p> <h3 id="还原切片"><a href="#还原切片" class="header-anchor">#</a> 还原切片</h3> <p>在后端需要将多个相同文件的切片还原成一个文件，上面这种处理切片的做法存在下面几个问题</p> <ul><li>如何识别多个切片是来自于同一个文件的，这个可以在每个切片请求上传递一个相同文件的<code>context</code>参数</li> <li>如何将多个切片还原成一个文件
<ul><li>确认所有切片都已上传，这个可以通过客户端在切片全部上传后调用<code>mkfile</code>接口来通知服务端进行拼接</li> <li>找到同一个 context 下的所有切片，确认每个切片的顺序，这个可以在每个切片上标记一个位置索引值</li> <li>按顺序拼接切片，还原成文件</li></ul></li></ul> <p>上面有一个重要的参数，即<code>context</code>，我们需要获取为一个文件的唯一标识，可以通过下面两种方式获取</p> <ul><li>根据文件名、文件长度等基本信息进行拼接，为了避免多个用户上传相同的文件，可以再额外拼接用户信息如 uid 等保证唯一性</li> <li>根据文件的二进制内容计算文件的 hash，这样只要文件内容不一样，则标识也会不一样，缺点在于计算量比较大.</li></ul> <p>修改上传代码，增加相关参数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 获取context，同一个文件会返回相同的值</span>
<span class="token keyword">function</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> file<span class="token punctuation">.</span>name <span class="token operator">+</span> file<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;[name=file]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">LENGTH</span> <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> chunks <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token constant">LENGTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取对于同一个文件，获取其的context</span>
<span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
chunks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 传递context</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;context&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 传递切片索引值</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/mkblk.php&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 所有切片上传完毕后，调用mkfile接口</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;context&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;chunks&quot;</span><span class="token punctuation">,</span> chunks<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/mkfile.php&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在<code>mkblk.php</code>接口中，我们通过<code>context</code>来保存同一个文件相关的切片</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// mkblk.php</span>
<span class="token variable">$context</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'context'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$path</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'./upload/'</span> <span class="token operator">.</span> <span class="token variable">$context</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 把同一个文件的切片放在相同的目录下</span>
<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$path</span> <span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'chunk'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>除了上面这种简单通过目录区分切片的方法之外，还可以将切片信息保存在数据库来进行索引。接下来是<code>mkfile.php</code>接口的实现，这个接口会在所有切片上传后调用</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// mkfile.php</span>
<span class="token variable">$context</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'context'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$chunks</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'chunks'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//合并后的文件名</span>
<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'./upload/'</span> <span class="token operator">.</span> <span class="token variable">$context</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/file.jpg'</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;=</span> <span class="token variable">$chunks</span><span class="token punctuation">;</span> <span class="token operator">++</span><span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'./upload/'</span><span class="token operator">.</span><span class="token variable">$context</span><span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span><span class="token variable">$i</span><span class="token punctuation">;</span> <span class="token comment">// 读取单个切块</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$fd</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">&quot;w+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$fd</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$fd</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将切块合并到一个文件上</span>
<span class="token punctuation">}</span>
<span class="token keyword">echo</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>

</code></pre></div><p>这样就解决了上面的两个问题：</p> <ul><li>识别切片来源</li> <li>保证切片拼接顺序</li></ul> <h3 id="断点续传"><a href="#断点续传" class="header-anchor">#</a> 断点续传</h3> <p>即使将大文件拆分成切片上传，我们仍需等待所有切片上传完毕，在等待过程中，可能发生一系列导致部分切片上传失败的情形，如网络故障、页面关闭等。由于切片未全部上传，因此无法通知服务端合成文件。这种情况下可以通过<strong>断点续传</strong>来进行处理。</p> <p>断点续传指的是：可以从已经上传部分开始继续上传未完成的部分，而没有必要从头开始上传，节省上传时间。</p> <p>由于整个上传过程是按切片维度进行的，且<code>mkfile</code>接口是在所有切片上传完成后由客户端主动调用的，因此断点续传的实现也十分简单：</p> <ul><li>在切片上传成功后，保存已上传的切片信息</li> <li>当下次传输相同文件时，遍历切片列表，只选择未上传的切片进行上传</li> <li>所有切片上传完毕后，再调用<code>mkfile</code>接口通知服务端进行文件合并</li></ul> <p>因此问题就落在了如何保存已上传切片的信息了，保存一般有两种策略</p> <ul><li>可以通过 locaStorage 等方式保存在前端浏览器中，这种方式不依赖于服务端，实现起来也比较方便，缺点在于如果用户清除了本地文件，会导致上传记录丢失</li> <li>服务端本身知道哪些切片已经上传，因此可以由服务端额外提供一个根据文件 context 查询已上传切片的接口，在上传文件前调用该文件的历史上传记录</li></ul> <p>下面让我们通过在本地保存已上传切片记录，来实现断点上传的功能</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 获取已上传切片记录</span>
<span class="token keyword">function</span> <span class="token function">getUploadSliceRecord</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> record <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 保存已上传切片</span>
<span class="token keyword">function</span> <span class="token function">saveUploadSliceRecord</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> sliceIndex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token function">getUploadSliceRecord</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sliceIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后对上传逻辑稍作修改，主要是增加上传前检测是已经上传、上传后保存记录的逻辑</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取上传记录</span>
<span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token function">getUploadSliceRecord</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
chunks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 已上传的切片则不再重新上传</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;context&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> task <span class="token operator">=</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/mkblk.php&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 上传成功后保存已上传切片记录</span>
    <span class="token function">saveUploadSliceRecord</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    record<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>此时上传时刷新页面或者关闭浏览器，再次上传相同文件时，之前已经上传成功的切片就不会再重新上传了。</p> <p>服务端实现断点续传的逻辑基本相似，只要在<code>getUploadSliceRecord</code>内部调用服务端的查询接口获取已上传切片的记录即可，因此这里不再展开。</p> <p>此外断点续传还需要考虑<strong>切片过期</strong>的情况：如果调用了<code>mkfile</code>接口，则磁盘上的切片内容就可以清除掉了，如果客户端一直不调用<code>mkfile</code>的接口，放任这些切片一直保存在磁盘显然是不可靠的，一般情况下，切片上传都有一段时间的有效期，超过该有效期，就会被清除掉。基于上述原因，断点续传也必须同步切片过期的实现逻辑。</p> <h3 id="上传进度和暂停"><a href="#上传进度和暂停" class="header-anchor">#</a> 上传进度和暂停</h3> <p>通过<a href="https://link.juejin.im?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FXMLHttpRequest%2Fupload" target="_blank" rel="noopener noreferrer">xhr.upload<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中的<code>progress</code>方法可以实现监控每一个切片上传进度。</p> <p>上传暂停的实现也比较简单，通过<code>xhr.abort</code>可以取消当前未完成上传切片的上传，实现上传暂停的效果，恢复上传就跟断点续传类似，先获取已上传的切片列表，然后重新发送未上传的切片。</p> <p>由于篇幅关系，上传进度和暂停的功能这里就先不实现了。</p> <p>作者：橙红年代<br>
链接：https://juejin.im/post/5cf765275188257c6b51775f<br>
来源：掘金</p> <h2 id="_3-第三方上传-阿里云上传实践"><a href="#_3-第三方上传-阿里云上传实践" class="header-anchor">#</a> 3. 第三方上传-阿里云上传实践</h2> <p><a href="https://help.aliyun.com/document_detail/64047.htm?" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_3-1-开通-oss-服务-使用-sts-临时访问凭证访问-oss"><a href="#_3-1-开通-oss-服务-使用-sts-临时访问凭证访问-oss" class="header-anchor">#</a> 3.1 开通 oss 服务，<a href="https://help.aliyun.com/document_detail/100624.htm?spm=a2c4g.11186623.0.0.683662e7icOmtd#concept-xzh-nzk-2gb" target="_blank" rel="noopener noreferrer">使用 STS 临时访问凭证访问 OSS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <h3 id="_3-2-普通上传-不支持使用进度函数-建议-100m-内使用-大文件会崩溃"><a href="#_3-2-普通上传-不支持使用进度函数-建议-100m-内使用-大文件会崩溃" class="header-anchor">#</a> 3.2 普通上传(不支持使用进度函数,建议 100M 内使用，大文件会崩溃)：</h3> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">async</span> <span class="token function">uploads</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OSS</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                region<span class="token operator">:</span> <span class="token string">'oss-cn-shenzhen'</span><span class="token punctuation">,</span>
                accessKeyId<span class="token operator">:</span> <span class="token string">'STS.xxx'</span><span class="token punctuation">,</span>
                accessKeySecret<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
                stsToken<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
                bucket<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> files <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token operator">=</span><span class="token string">'test/file/'</span><span class="token operator">+</span>files<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token operator">=</span>files
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
           <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//回调</span>
         <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-3-分片上传"><a href="#_3-3-分片上传" class="header-anchor">#</a> 3.3 分片上传</h3> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> tempCheckpoint<span class="token operator">=</span><span class="token keyword">null</span>  <span class="token comment">// 该字段保存分片上传信息，用于重传</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">multipartUpload</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> files<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">progress</span><span class="token operator">:</span>  <span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> checkpoint</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进度'</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tempCheckpoint<span class="token operator">=</span>checkpoint
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      parallel<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token comment">// 设置分片大小。默认值为1 MB，最小值为100 KB。</span>
      partSize<span class="token operator">:</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>
      meta<span class="token operator">:</span> <span class="token punctuation">{</span> year<span class="token operator">:</span> <span class="token number">2020</span><span class="token punctuation">,</span> people<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//meta 元信息，如开启 md5校验可以 传递 Content-MD5 进行比对保证文件上传一致性</span>
      mime<span class="token operator">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    client<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'出错了，请点击按钮重传'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//分片 重传</span>
  <span class="token keyword">async</span>  <span class="token function">resumeUpload</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> resumeclient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OSS</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ossConfig<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//需要重新new</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> resumeclient<span class="token punctuation">.</span><span class="token function">multipartUpload</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> files<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token function-variable function">progress</span><span class="token operator">:</span>  <span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> checkpoint</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'重传进度'</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>tempCheckpoint <span class="token operator">=</span> checkpoint<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            checkpoint<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tempCheckpoint<span class="token punctuation">,</span>
            meta<span class="token operator">:</span> <span class="token punctuation">{</span> year<span class="token operator">:</span> <span class="token number">2020</span><span class="token punctuation">,</span> people<span class="token operator">:</span> <span class="token string">'test'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            mime<span class="token operator">:</span> <span class="token string">'text/plain'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre></div><h2 id="_4-第三方上传-又拍云上传实践"><a href="#_4-第三方上传-又拍云上传实践" class="header-anchor">#</a> 4. 第三方上传-又拍云上传实践</h2> <blockquote><p>无 sdk,react 业务代码示例</p></blockquote> <p><a href="http://docs.upyun.com/api/rest_api/" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li><p><strong>开发前需要了解知识点</strong>：</p> <ol><li><p>浏览器有请求并发数限制，所以并发上传最好控制在 6 个请求左右</p></li> <li><p>页面关闭，切换，窗口关闭，切换，根据业务需求是否要断开上传，暂停上传或销毁上传对象，是否需要后台上传，如果有后台上传考虑使用 <code>web worker</code></p></li> <li><p>又拍云分片上传使用 put 上传并且返回信息在 response header 里面</p></li></ol></li> <li><p><strong>又拍云准备</strong>：</p> <ol><li><p>又拍云上传域名 智能选路（推荐） v0.api.upyun.com</p></li> <li><p>密钥 :</p> <ul><li>upyunApi 又拍云上传域名</li> <li>domain 域名</li> <li>bucketName 空间名称</li> <li>username 账号</li> <li>password 密码</li></ul></li></ol> <h3 id="_4-1-创建-又拍云签名-以及上传路径信息"><a href="#_4-1-创建-又拍云签名-以及上传路径信息" class="header-anchor">#</a> 4.1 创建 又拍云签名,以及上传路径信息</h3> <ol><li><p>filePath 上传路径 ：</p> <ul><li>又拍云上传域名 + 空间名称 + 文件类型 + 上传日期 + 文件名称</li></ul></li> <li><p>Signature <a href="http://docs.upyun.com/api/authorization/" target="_blank" rel="noopener noreferrer">签名生成<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> :</p> <ul><li><p>Signature = Base64 ( HMAC-SHA1 ( md5 ( Password ) + Method + URI + Date ) )</p></li> <li><p>使用 base6 包裹，HMAC-SHA1 包裹，密码使用 md5 加密，method 为 put ,URL 为 filePath 上传路径，Date 为当前时间 GMT 格式</p></li> <li><p>最后 请求头加上 <code>Authorization</code> : <code>UPYUN ${username}:${Signature}</code></p></li></ul></li> <li><p>代码示例：</p></li></ol></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> md5 <span class="token keyword">from</span> <span class="token string">&quot;md5&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> b64hamcsha1 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/utils/uploader&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Env <span class="token keyword">from</span> <span class="token string">&quot;@/utils/env&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> moment <span class="token keyword">from</span> <span class="token string">&quot;moment&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> UpyunAuth <span class="token operator">=</span> <span class="token punctuation">{</span>
  domain<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Env<span class="token punctuation">.</span>domain<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  username<span class="token operator">:</span> Env<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
  pwdMd5<span class="token operator">:</span> <span class="token function">md5</span><span class="token punctuation">(</span>Env<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span>
  api<span class="token operator">:</span> Env<span class="token punctuation">.</span>upyunApi<span class="token punctuation">,</span>
  bucketName<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Env<span class="token punctuation">.</span>bucketname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  filePath<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 当前文件类型(调用组件传入uploadTypePath)+时间 video/2020-2-2/xxx.mp4 - file/2020-2-2/xxx.doc</span>
  <span class="token function">createUploadUrl</span><span class="token punctuation">(</span><span class="token parameter">fileName<span class="token operator">:</span> string<span class="token punctuation">,</span> uploadTypePath<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uploadTypePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
      <span class="token string">&quot;YYYY-MM-DD&quot;</span>
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> bucketName<span class="token punctuation">,</span> filePath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bucketName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">createAuthHeader</span><span class="token punctuation">(</span><span class="token parameter">fileName<span class="token operator">:</span> string<span class="token punctuation">,</span> contentType<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUTCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> pwdMd5<span class="token punctuation">,</span> bucketName<span class="token punctuation">,</span> filePath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> Signature <span class="token operator">=</span> <span class="token function">b64hamcsha1</span><span class="token punctuation">(</span>
      pwdMd5<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">PUT&amp;/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bucketName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>time<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;Content-Type&quot;</span><span class="token operator">:</span> contentType<span class="token punctuation">,</span>
      <span class="token string">&quot;X-Date&quot;</span><span class="token operator">:</span> time<span class="token punctuation">,</span>
      Authorization<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">UPYUN </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Signature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> UpyunAuth<span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-2-创建-原生-xhr-对象"><a href="#_4-2-创建-原生-xhr-对象" class="header-anchor">#</a> 4.2 创建 原生 xhr 对象</h3> <blockquote><p>因业务代码通常使用 axios 等类库进行封装，再引入修改会冲突</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> XMLHttpRequest <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ActiveXObject <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> xhrArr <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;Microsoft.XMLHTTP&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;MSXML2.XMLHTTP.6.0&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;MSXML2.XMLHTTP.5.0&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;MSXML2.XMLHTTP.4.0&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;MSXML2.XMLHTTP.3.0&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;MSXML2.XMLHTTP&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> xhrArr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span>xhrArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;No XHR object available.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">option</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">&quot;[object Object]&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token function">createXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/**
       *  res header
       *  status  204 成功
       *    complete  201 成功 204 覆盖成功
       *
       * 初始化，上传中 X-Upyun-Multi-Uuid 本次上传任务的标识(初始化上传后返回的信息，用于续传)
       * 结束 X-Upyun-Multi-Uuid X-Upyun-Multi-Type X-Upyun-Multi-Length
       */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">204</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">201</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// xhr.getResponseHeader('status')</span>
        <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// if (option.uploadStatus === 'initiate' || option.uploadStatu === 'upload') {</span>
        response<span class="token punctuation">[</span><span class="token string">&quot;Uuid&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> xhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Upyun-Multi-Uuid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// }</span>
        <span class="token comment">// if (option.uploadStatus === 'complete') {</span>
        <span class="token comment">// response['Uuid'] = xhr.getResponseHeader('X-Upyun-Multi-Uuid')</span>
        <span class="token comment">// }</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>option<span class="token punctuation">.</span>success <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> option<span class="token punctuation">.</span>success <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          option<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>option<span class="token punctuation">.</span>error <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> option<span class="token punctuation">.</span>error <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          option<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;success not is function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
        xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">401</span> <span class="token operator">&amp;&amp;</span>
        option<span class="token punctuation">.</span>error <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">typeof</span> option<span class="token punctuation">.</span>error <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        option<span class="token punctuation">.</span><span class="token function">authError</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>option<span class="token punctuation">.</span>error <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> option<span class="token punctuation">.</span>error <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        option<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>option<span class="token punctuation">.</span>method<span class="token punctuation">,</span> option<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>option<span class="token punctuation">.</span>header<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">&quot;[object Object]&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> option<span class="token punctuation">.</span>header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> option<span class="token punctuation">.</span>header<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>option<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// request({</span>
<span class="token comment">//   url: 'api',</span>
<span class="token comment">//   method: 'PUT',</span>
<span class="token comment">//   uploadStatus:'',</span>
<span class="token comment">//   header: {},</span>
<span class="token comment">//   data: 'file',</span>
<span class="token comment">//   success(res) {</span>

<span class="token comment">//   },</span>
<span class="token comment">//   error(err) {</span>

<span class="token comment">//   },</span>
<span class="token comment">// })</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> request<span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-3-文件分片-md5-加密"><a href="#_4-3-文件分片-md5-加密" class="header-anchor">#</a> 4.3 文件分片，md5 加密</h3> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">import</span> SparkMD5 <span class="token keyword">from</span> <span class="token string">'spark-md5'</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取分片 spark-md5  const { blobsList, getMd5 } = await getBlobMd5(this.file, this.chunkSize); // 获取分片数据</span>
  <span class="token keyword">const</span> <span class="token function-variable function">getBlobMd5</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> chunkSize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> blobSlice <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice <span class="token operator">||</span> <span class="token class-name">File</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>mozSlice <span class="token operator">||</span> <span class="token class-name">File</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>webkitSlice<span class="token punctuation">;</span>
    <span class="token keyword">const</span> chunks <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> currentChunk <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> blobsList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> spark <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkMD5<span class="token punctuation">.</span>ArrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fileReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      fileReader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        spark<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentChunk<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentChunk <span class="token operator">&lt;</span> chunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">loadNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> getMd5 <span class="token operator">=</span> spark<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> blobsList<span class="token punctuation">,</span> getMd5 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      fileReader<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'getBlobMd5, something went wrong.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">function</span> <span class="token function">loadNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> start <span class="token operator">=</span> currentChunk <span class="token operator">*</span> chunkSize<span class="token punctuation">;</span>
        <span class="token keyword">const</span> end <span class="token operator">=</span> start <span class="token operator">+</span> chunkSize <span class="token operator">&gt;=</span> file<span class="token punctuation">.</span>size <span class="token operator">?</span> file<span class="token punctuation">.</span>size <span class="token operator">:</span> start <span class="token operator">+</span> chunkSize<span class="token punctuation">;</span>
        <span class="token keyword">const</span> blobs <span class="token operator">=</span> <span class="token function">blobSlice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        blobsList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileReader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">loadNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-4-上传核心方法-uploader-类"><a href="#_4-4-上传核心方法-uploader-类" class="header-anchor">#</a> 4.4 上传核心方法 uploader 类</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> RcFile <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd/lib/upload'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token constant">REQUEST</span> <span class="token keyword">from</span> <span class="token string">'./request'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> UpyunAuth <span class="token keyword">from</span> <span class="token string">'./upyunAuth'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getBlobMd5 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/utils/uploader'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Uploader</span> <span class="token punctuation">{</span>
file<span class="token operator">:</span> RcFile<span class="token punctuation">;</span>

fileName<span class="token operator">:</span> string<span class="token punctuation">;</span>

fileType<span class="token operator">:</span> string<span class="token punctuation">;</span>

fileSize<span class="token operator">:</span> string<span class="token punctuation">;</span>

chunkSize<span class="token operator">:</span> number<span class="token punctuation">;</span>

blobList<span class="token operator">:</span> Blob<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

uploadQueue<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

onSuccess<span class="token operator">:</span> any<span class="token punctuation">;</span>

onProgress<span class="token operator">:</span> any<span class="token punctuation">;</span>

onError<span class="token operator">:</span> any<span class="token punctuation">;</span>

uploadError<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

uploadMax<span class="token operator">:</span> number<span class="token punctuation">;</span>

uploadNum<span class="token operator">:</span> number<span class="token punctuation">;</span>

uploadUrl<span class="token operator">:</span> string<span class="token punctuation">;</span>

Uuid<span class="token operator">:</span> string<span class="token punctuation">;</span>

isUnstall<span class="token operator">:</span> boolean<span class="token punctuation">;</span>

uploadCurrent<span class="token operator">:</span> number<span class="token punctuation">;</span>

uploadedSuccessNum<span class="token operator">:</span> number<span class="token punctuation">;</span>

uploadedErrorNum<span class="token operator">:</span> number<span class="token punctuation">;</span>

uploadProgess<span class="token operator">:</span> number<span class="token punctuation">;</span>

uploadTypePath<span class="token operator">:</span> string<span class="token punctuation">;</span>

uploadStep<span class="token operator">:</span>string<span class="token punctuation">;</span>

<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> file<span class="token punctuation">,</span> onProgress<span class="token punctuation">,</span> onSuccess<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> uploadTypePath <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> size<span class="token punctuation">,</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> file<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>fileType <span class="token operator">=</span> type<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">=</span> size<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadTypePath <span class="token operator">=</span> uploadTypePath<span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// bytes =&gt; kb =  mb</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>blobList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 分片数量</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 上传队列</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadError <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 上传错误队列</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadedSuccessNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 已上传成功数量</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadedErrorNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 已上传失败数量</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadMax <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 上传最大数</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadNum <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 上传队列控制数量</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadCurrent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 上传队列当前上传位置</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadProgess <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadUrl <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>Uuid <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span> <span class="token comment">// 断点续传文件id</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>isUnstall <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 页面是否卸载</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>onProgress <span class="token operator">=</span> onProgress<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onSuccess <span class="token operator">=</span> onSuccess<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onError <span class="token operator">=</span> onError<span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadStep <span class="token operator">=</span> <span class="token string">'uploadStart || uploading || uploadEnd'</span> <span class="token comment">// 当前上传步骤状态</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> blobsList<span class="token punctuation">,</span> getMd5 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getBlobMd5</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>file<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取分片数据</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>blobList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>blobsList<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> m_pattern <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>getMd5<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m_pattern<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token comment">// this.fileName = `${getMd5}__${encodeURIComponent(this.fileName)}`;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadUrl <span class="token operator">=</span> UpyunAuth<span class="token punctuation">.</span><span class="token function">createUploadUrl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadTypePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建上传链接</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadProgess <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>blobList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 每次增加的进度百分比</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isUnstall<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">uploadStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 *  1. 创建分片数组
 *  2. 初始化上传
 *  3. 创建上传队列
 *  4. 开始上传 ： 上传成功，计数成功数量与需要上传队列数量相等，上传成功。
 *                上传错误，传入错误队列，报错,记录上传进度， 重传 =&gt; 赋值上传队列，清空错误队列，继续上传
 *  5. 上传结束
 *
 */</span>

<span class="token function">uploadStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadStep <span class="token operator">=</span> <span class="token string">'uploadStart'</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> fileName<span class="token punctuation">,</span> fileSize<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> chunkSize<span class="token punctuation">,</span> uploadUrl <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token constant">REQUEST</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token operator">:</span> uploadUrl<span class="token punctuation">,</span>
    method<span class="token operator">:</span> <span class="token string">'PUT'</span><span class="token punctuation">,</span>
    uploadStatus<span class="token operator">:</span> <span class="token string">'initiate'</span><span class="token punctuation">,</span>
    header<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>UpyunAuth<span class="token punctuation">.</span><span class="token function">createAuthHeader</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'X-Upyun-Multi-Disorder'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string">'X-Upyun-Multi-Stage'</span><span class="token operator">:</span> <span class="token string">'initiate'</span><span class="token punctuation">,</span>
      <span class="token string">'X-Upyun-Multi-Length'</span><span class="token operator">:</span> fileSize<span class="token punctuation">,</span>
      <span class="token string">'X-Upyun-Multi-Part-Size'</span><span class="token operator">:</span> chunkSize<span class="token punctuation">,</span>
      <span class="token string">'X-Upyun-Multi-Type'</span><span class="token operator">:</span> fileType<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> Uuid <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> Uuid<span class="token operator">:</span> string <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>Uuid <span class="token operator">=</span> Uuid<span class="token punctuation">;</span>
      <span class="token comment">// 创建上传队列</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createUploadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">controlUploadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">authError</span><span class="token operator">:</span> <span class="token parameter">status</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">createUploadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadStep <span class="token operator">=</span> <span class="token string">'uploading'</span>

  <span class="token keyword">const</span> uploadLength <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>blobList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 需要上传数量</span>
  <span class="token comment">// blob 上传对象 index 上传顺序标识</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>blobList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">blob<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建上传队列，数组值为上传函数接收 鉴权header 、当前上传任务索引 (用于查找上传错误任务)uploadIndex</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uploadQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">header<span class="token punctuation">,</span> uploadIndex</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token constant">REQUEST</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadUrl<span class="token punctuation">,</span>
        method<span class="token operator">:</span> <span class="token string">'PUT'</span><span class="token punctuation">,</span>
        uploadStatus<span class="token operator">:</span> <span class="token string">'upload'</span><span class="token punctuation">,</span>
        header<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>header<span class="token punctuation">,</span>
          <span class="token string">'X-Upyun-Multi-Stage'</span><span class="token operator">:</span> <span class="token string">'upload'</span><span class="token punctuation">,</span>
          <span class="token string">'X-Upyun-Multi-Uuid'</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Uuid<span class="token punctuation">,</span>
          <span class="token string">'X-Upyun-Part-Id'</span><span class="token operator">:</span> index<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> blob<span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 上传完成 检测错误队列，清空上传队列，重新赋值上传队列，清空错误队列，报错，让用户手动上传</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>uploadedSuccessNum<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// uploadedSuccessNum 已上传成功任务计数</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>uploadedSuccessNum <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadedErrorNum <span class="token operator">===</span> uploadLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 上传最后一个任务</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>uploadedErrorNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 有上传错误任务</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>uploadedErrorNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 重置错误计数</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>uploadCurrent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 当前上传位置重置</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>uploadNum <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadMax<span class="token punctuation">;</span> <span class="token comment">// 上传最大数位置重置</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>uploadQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadQueue<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadError<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重置上传队列</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>uploadError <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 清空错误队列</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 没有上传错误任务 全部成功</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              percent<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">uploadEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保证所有请求完毕再执行最后一步 否则会出 some part miss</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>uploadNum<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 上传最大数位置递增（for循环调用上传任务队列后 归零，上传成功失败后 递增，实现队列+1上传）</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            percent<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadProgess <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadedSuccessNum<span class="token punctuation">,</span> <span class="token comment">// 记录上传进度</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">controlUploadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 队列上传</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 上传完成 检测错误队列，清空上传队列，重新赋值上传队列，清空错误队列，报错，让用户手动上传</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>uploadedErrorNum<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 已上传失败任务计数</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>uploadedSuccessNum <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadedErrorNum <span class="token operator">===</span> uploadLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>uploadedErrorNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 重置错误计数</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>uploadCurrent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 当前上传位置重置</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>uploadNum <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadMax<span class="token punctuation">;</span> <span class="token comment">// 上传最大数位置重置</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>uploadError<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>uploadIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 放入错误队列（uploadIndex=&gt;数组索引）</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>uploadQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadQueue<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
              <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadError<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重置上传队列</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>uploadError <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 清空错误队列</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>uploadNum<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>uploadError<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>uploadIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">controlUploadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">uploadEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadStep <span class="token operator">=</span> <span class="token string">'uploadEnd'</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> uploadUrl<span class="token punctuation">,</span> Uuid <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token constant">REQUEST</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token operator">:</span> uploadUrl<span class="token punctuation">,</span>
    method<span class="token operator">:</span> <span class="token string">'PUT'</span><span class="token punctuation">,</span>
    uploadStatus<span class="token operator">:</span> <span class="token string">'complete'</span><span class="token punctuation">,</span>
    header<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>UpyunAuth<span class="token punctuation">.</span><span class="token function">createAuthHeader</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'X-Upyun-Multi-Stage'</span><span class="token operator">:</span> <span class="token string">'complete'</span><span class="token punctuation">,</span>
      <span class="token string">'X-Upyun-Multi-Uuid'</span><span class="token operator">:</span> Uuid<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> Uuid <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// const sourceUrl = UpyunAuth.domain + UpyunAuth.filePath + fileName;</span>
      <span class="token comment">// 相对路径</span>
      <span class="token keyword">const</span> sourceUrl <span class="token operator">=</span> UpyunAuth<span class="token punctuation">.</span>filePath <span class="token operator">+</span> fileName<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onSuccess</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">authError</span><span class="token operator">:</span> <span class="token parameter">status</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 控制上传队列数量
 * controlUploadQueue for 循环 uploadNum ，uploadNum 归零，上传成功 uploadNum 递增  ,上传失败 uploadNum 递增
 * 上传成功失败都要调用  controlUploadQueue for 循环  uploadNum
 * uploadCurrent + uploadNum当前上传位置 =&gt; （需要上传的任务）&lt;= 最大上传位置
 *
 */</span>
<span class="token function">controlUploadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">,</span> uploadNum<span class="token punctuation">,</span> uploadQueue<span class="token punctuation">,</span> uploadCurrent<span class="token punctuation">,</span> isUnstall <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isUnstall<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> uploadCurrent<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> uploadCurrent <span class="token operator">+</span> uploadNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      count<span class="token operator">++</span><span class="token punctuation">;</span>
      uploadQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>UpyunAuth<span class="token punctuation">.</span><span class="token function">createAuthHeader</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> fileType<span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// header鉴权 i当前任务在上传队列中的索引</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadCurrent <span class="token operator">+=</span> count<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploadNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">reUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> uploadStep <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token comment">// 重传步骤</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadStep <span class="token operator">===</span> <span class="token string">'uploadStart'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">uploadStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadStep <span class="token operator">===</span> <span class="token string">'uploading'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">controlUploadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadStep <span class="token operator">===</span> <span class="token string">'uploadEnd'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">uploadEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Uploader<span class="token punctuation">;</span>

</code></pre></div><h3 id="_4-5-调用方法"><a href="#_4-5-调用方法" class="header-anchor">#</a> 4.5 调用方法</h3> <div class="language-js extra-class"><pre class="language-js"><code>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clearUploaderTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 自定义上传回调函数</span>
  <span class="token keyword">const</span> options<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> percent <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> percent<span class="token operator">:</span> number <span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token parameter">sourceUrl<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">onError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    uploadTypePath<span class="token operator">:</span><span class="token string">'file'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
   
  <span class="token keyword">const</span> uploader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uploader</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>uploader <span class="token operator">=</span> uploader<span class="token punctuation">;</span>

  <span class="token function">clearUploaderTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>uploader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>uploader<span class="token punctuation">.</span>uploadQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>uploader<span class="token punctuation">.</span>isUnstall <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>uploader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  reUpload <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uploader<span class="token punctuation">.</span><span class="token function">reUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>



  
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/use/fn.html" class="prev">
        前端开发常用方法复制
      </a></span> <span class="next"><a href="/pages/use/excel.html">
        导入导出excel
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e6819fdb.js" defer></script><script src="/assets/js/2.1d159e52.js" defer></script><script src="/assets/js/108.b6d436c2.js" defer></script>
  </body>
</html>
