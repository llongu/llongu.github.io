<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width"
	/>
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>Hello APP</title>
	<link rel="stylesheet" href="./css/api.css" />
	<link rel="stylesheet" href="./css/public.css" />
	<link rel="stylesheet" href="./css/aui.css" />
	<style type="text/css">
		html,
		body {
			background: url(image/n_login_bg.png) no-repeat;
			background-size: 100% 100%;
			background-position: 100% 100%;
		}

		body .aui-bar-nav {
			background: transparent !important;
			border-bottom: none !important;
			color: #fff;
			color: #fff;
			color: #fff;
			overflow: hidden;
		}

		.lan {
			width: 30px;
			height: 18px;
			padding-right: 5px;
		}

		.lan li {
			width: 100%;
			height: 100%;
		}


		.lan_ico {
			width: 30px;
			height: 18px;
			float: left;
			margin-right: 5px;
		}

		#main {
			position: relative;
			clear: both;
			overflow: hidden;
		}

		#main .line {
			width: 18rem;
			height: auto;
			position: absolute;
			top: 4rem;
			left: 0;
		}

		#main .form {
			width: 80%;
			margin: 0 auto;
			margin-top: 12rem;
			position: relative;
			z-index: 1000;
		}

		#main .formdiv {
			width: 100%;
			margin-bottom: 10px;
			clear: both;
		}

		#main .formdiv label {
			display: block;
			font-size: 14px;
			color: #fff;
		}

		#main .formdiv label img {
			width: 18px;
			height: 16px;
			margin-left: 30px;
			margin-right: 15px;
			float: left;
		}

		#main .formdiv input {
			width: 100%;
			height: 45px;
			display: block;
			border-radius: 23px;
			font-size: 16px;
			text-indent: 30px;
			font-weight: bold;
			color: #000;
			background: #fff;
			margin: 5px 0 15px;
		}

		#main .formdiv input::-webkit-input-placeholder {
			font-weight: normal;
			color: #ccc;
		}

		.forGet {
			text-align: right;
			color: #00A8AA;
			font-size: 14px;
			margin-bottom: 15px;
		}

		.now {
			width: 100%;
			height: 45px;
			line-height: 45px;
			text-align: center;
			border-radius: 23px;
			color: #fff;
			font-size: 16px;
			background: -webkit-linear-gradient(to right, #00C1A8, #0F8ADE);
			background: linear-gradient(to right, #00C1A8, #0F8ADE);
		}

		.register {
			font-size: 14px;
			color: #fff;
			text-align: center;
			padding: 5px 0;
		}

		.register span {
			color: #00A8AA;
		}

		.guoqi {
			width: 18rem;
			height: auto;
			margin: 0 auto;
		}

		#top-right {
			position: absolute;
		}

		.aui-list .aui-list-item-inner {
			justify-content: start;
			-webkit-justify-content: start;
		}

		.aui-popup {
			min-width: 5.5rem;
			opacity: initial;
		}

		.aui-popup-content {
			min-height: auto;
		}

		.aui-list .aui-list-item {
			min-height: 1.7rem;
		}

		.aui-list .aui-list-item-inner {
			min-height: 1.7rem;
		}

		.aui-popup-top-right .aui-popup-arrow {
			right: 0.13rem;
			margin-top: -0.35rem;
		}

		.shadow {
			width: .58rem;
			height: .58rem;
			position: absolute;
			border-radius: 50%;
		}

		.shadow div {
			width: 100%;
			height: 100%;
			border-radius: 50%;
			position: absolute;
			background: #fff;
			left: 50%;
			top: 50%;
			margin-left: -.29rem;
			margin-top: -.29rem;
		}

		.shadow div:first-child {
			border: .13rem solid #072742;
			box-sizing: border-box;
			z-index: 10;
		}

		.shadow div:nth-child(2) {
			z-index: 9;
			-webkit-animation: opacity1 2.8s ease-in infinite;
			animation: opacity1 2.8s ease-in infinite;
		}

		.shadow div:nth-child(3) {
			z-index: 8;
			-webkit-animation: opacity2 2.8s ease-in infinite;
			animation: opacity2 2.8s ease-in infinite;

		}

		.shadow div:nth-child(4) {
			-webkit-animation: opacity3 2.8s ease-in infinite;
			animation: opacity3 2.8s ease-in infinite;

		}

		.shadow1 {
			right: 3.1rem;
			bottom: 7.1rem;
		}

		.shadow2 {
			right: 7.5rem;
			bottom: 11.3rem;
		}

		.shadow3 {
			right: 6.97rem;
			bottom: 7.55rem;
		}

		.shadow4 {
			right: 12.1rem;
			bottom: 9.49rem;
		}

		.shadow1 div {
			-webkit-animation-delay: .5s !important;
			animation-delay: .5s !important;
		}

		.shadow3 div {
			-webkit-animation-delay: 1s !important;
			animation-delay: 1s !important;
		}

		.shadow4 div {
			-webkit-animation-delay: 1.5s !important;
			animation-delay: 1.5s !important;
		}

		@keyframes opacity1 {
			from {
				transform: scale(1);
				opacity: 1;
			}
			to {
				transform: scale(2);
				opacity: .15;
			}
		}

		@-webkit-keyframes opacity1 {
			from {
				-webkit-transform: scale(1);
				transform: scale(1);
				opacity: 1;
			}
			to {
				-webkit-transform: scale(2);
				transform: scale(2);
				opacity: .15;
			}
		}

		@keyframes opacity2 {
			from {
				transform: scale(1);
				opacity: 1;
			}
			to {
				transform: scale(2.8);
				opacity: .1;
			}
		}

		@-webkit-keyframes opacity2 {
			from {
				-webkit-transform: scale(1);
				transform: scale(1);
				opacity: 1;
			}
			to {
				-webkit-transform: scale(2.8);
				transform: scale(2.8);
				opacity: .1;
			}
		}

		@keyframes opacity3 {
			from {
				transform: scale(1);
				opacity: 1;
			}
			to {
				transform: scale(4);
				opacity: 0;
			}
		}

		@-webkit-keyframes opacity3 {
			from {
				-webkit-transform: scale(1);
				transform: scale(1);
				opacity: 1;
			}
			to {
				-webkit-transform: scale(4);
				transform: scale(4);
				opacity: 0;
			}
		}
		.aui-popup-content .aui-list img{
			width: 1.2rem;
		}
	</style>
</head>

<body id="body">
	<div id="app">
		<header class="aui-bar aui-bar-nav ">
			<div class="aui-title">{{ fontlist.login_btn }}</div>
			<a class="aui-pull-right aui-btn " aui-popup-for="top-right" @click="lanState=!lanState">
				<ul class="lan">
					<li>
						<img :src="lanImg" />
					</li>
				</ul>
				<span class="iconfont">&#xe698;</span>
			</a>
		</header>

		<div id="main">
			<div class="line">
				<div class="shadow1 shadow">
					<div></div>
					<div></div>
					<div></div>
					<div></div>
				</div>
				<div class="shadow2 shadow">
					<div></div>
					<div></div>
					<div></div>
					<div></div>
				</div>
				<div class="shadow3 shadow">
					<div></div>
					<div></div>
					<div></div>
					<div></div>
				</div>
				<div class="shadow4 shadow">
					<div></div>
					<div></div>
					<div></div>
					<div></div>
				</div>
				<img src="image/n_login_y1.png" />
			</div>

			<div class="form">
				<div class="formdiv">
					<label for="">
						<img src="image/n_user.png" />{{ fontlist.login_user }}</label>
					<input type="text" value="" v-model="u_name" :placeholder="fontlist.login_uidInput" />
				</div>
				<div class="formdiv">
					<label for="">
						<img src="image/n_lock.png" style="width: 13px;" />{{ fontlist.login_psw }}</label>
					<input type="password" value="" v-model="u_password" :placeholder="fontlist.login_loginPwdInput" />
				</div>
				<div class="forGet" @click="forGet">{{ fontlist.login_forget }}</div>
				<div class="now" @click="login">{{ fontlist.login_now }}</div>
				<div class="register">{{ fontlist.login_no }}
					<span @click="register">{{ fontlist.login_register }}</span>
				</div>
			</div>
			<div class="guoqi">
				<img src="image/n_login_bg2.png" />
			</div>

			<div class="aui-popup aui-popup-top-right" v-show="lanState" id="top-right">
				<div class="aui-popup-arrow"></div>
				<div class="aui-popup-content">
					<ul class="aui-list aui-list-noborder">
						<li class="aui-list-item" @click="lanChange('zh')">
							<div class="aui-list-item-inner aui-list-item-middle">
								<img src="image/lan_zh.png" class="lan_ico" /> 中文
							</div>
						</li>
						<li class="aui-list-item" @click="lanChange('en')">
							<div class="aui-list-item-inner">
								<img src="image/lan_en.png" class="lan_ico" /> English
							</div>
						</li>
						<li class="aui-list-item" @click="lanChange('jp')">
							<div class="aui-list-item-inner">
								<img src="image/lan_jp.png" class="lan_ico" /> 日本語
							</div>
						</li>
						<li class="aui-list-item" @click="lanChange('kor')">
							<div class="aui-list-item-inner">
								<img src="image/lan_ko.png" class="lan_ico" /> 한국어.
							</div>
						</li>
						<li class="aui-list-item" @click="lanChange('ru')">
							<div class="aui-list-item-inner">
								<img src="image/lan_ru.png" class="lan_ico" /> русский язык
							</div>
						</li>
						<li class="aui-list-item" @click="lanChange('pt')">
							<div class="aui-list-item-inner">
								<img src="image/lan_pt.png" class="lan_ico" /> Português
							</div>
						</li>
						<li class="aui-list-item" @click="lanChange('vi')">
							<div class="aui-list-item-inner">
								<img src="image/lan_vi.png" class="lan_ico" /> Tiếng Việt
							</div>
						</li>
					</ul>
				</div>
			</div>
		</div>

	</div>
</body>
<script type="text/javascript" src="./script/api.js"></script>
<script type="text/javascript" src="./script/vue.js"></script>
<script type="text/javascript" src="./script/text.js"></script>
<script type="text/javascript" src="./script/common.js"></script>
<script type="text/javascript" src="./script/fastclick.min.js"></script>
<script type="text/javascript" src="./script/db.js"></script>
<script type="text/javascript" src="./script/socket.js"></script>
<script type="text/javascript">
	window.onload = function () {
		var body = document.getElementById('body');
		body.style.height = document.getElementById('body').clientHeight + 'px';
	};


	var vm = new Vue({
		el: "#app",
		data: {
			fontlist: font,//语言Obj
			lanImg: '',//语言图片
			lanState: false,
			u_name: '',
			u_password: '',
		},
		methods: {
			init: function () {
				//初始化语言
				vm.lanChange(localStorage.getItem('newnum'));
				//获取header 已经登录  登录  取得socket的token 创建socket
				// new MyPromise(getCheckVal, function () {
				// 	Mysocket.create();
				// }).then(oldogin).then(logins).then(getSocketAuth).then(getSelfInfo);

			},
			lanChange: function (type) {//语言切换及存储
				this.lanImg = 'image/lan_' + type + '.png';
				this.fontlist = FONT[type];
				this.lanState = false;
				localStorage.setItem('newnum', type);
			},
			login: function () {
				// 登录  取得socket的token   创建socket
				alert('需下载APP进行操作');
				api.openWin({
					name: 'index_footer',
					url: './html/index_footer.html'
				});
				// new MyPromise(logins, function () {
				// 	Mysocket.create();
				// }).then(getSocketAuth).then(getSelfInfo)
			},
			forGet: function () {
				api.openWin({
					name: 'forget_head',
					url: './html/forget_head.html'
				});
			},
			register: function () {
				api.openWin({
					name: 'register_head',
					url: './html/register_head.html'
				});
			}

		}

	})

	apiready = function () {

		var header = $api.dom('header'); // 获取 header 标签元素
		var headerH = $api.fixStatusBar(header);

		//socket
		window.Mysocket = new socketManager();
		//数据库模块
		var db = api.require('db');
		dbModule = DbSqliteIm.createNew(db);
		vm.init();
		// dbModule.clear();

		//退出登陆
		api.addEventListener({
			name: 'loginout'
		}, function (ret, err) {
			dbModule.clear();
			Mysocket.close();
		});
		api.addEventListener({
			name: 'smartupdatefinish'
		}, function (ret, err) {
			api.toast({
				msg: '系统更新完毕',
				duration: 3000,
				location: 'bottom'
			});
			api.rebootApp();
		});
		//网络已断开，请检查网络
		api.addEventListener({
			name: 'offline'
		}, function (ret, err) {
			api.toast({
				msg: font.login_offline,
				duration: 2000,
				location: 'bottom'
			});
			Mysocket.close();
		});

		//语音播报
		// api.addEventListener({
		// 	name: 'voice'
		// }, function (ret, err) {
		// 	console.log(ret.value.msg);

		// });

		//好友请求
		api.addEventListener({
			name: 'firend'
		}, function (ret, err) {
			// console.log(JSON.stringify(ret.value) + '好友请求');
			var sendmsg = {
				"target_id": ret.value.targetId,
				"msgType": ret.value.type,//申请好友类型
			};
			// if (ret.value.type == 'friendRequest') {//添加好友
			// 	sendmsg.target_id = ret.value.targetId;
			// 	sendmsg.msgType = "friendRequest";
			// }
			// if (ret.value.type == 'agreeFriend') {//同意好友申请
			// 	sendmsg.target_id = ret.value.targetId;
			// 	sendmsg.msgType = "agreeFriend";
			// }
			// if (ret.value.type == 'delFriend') {//被删除好友通知
			// 	sendmsg.target_id = ret.value.targetId;
			// 	sendmsg.msgType = "delFriend";
			// }

			Mysocket.write(privateMsg(sendmsg));
		});

		//好友聊天 发送
		api.addEventListener({
			name: 'sendfirendchat'
		}, function (ret, err) {
			var msg = privateMsg(ret.value);
			Mysocket.write(msg, function () {//信息发送成功
				// console.log(JSON.stringify(msg) + '好友聊天发送成功 入库信息查看')
				//入库
				dbModule.pushMessage(msg.target_id, msg);
				//渲染数据
				api.sendEvent({
					name: 'sendSuccess',
					extra: {
						msg: msg
					}
				})
				//通知 会话列表
				api.sendEvent({
					name: 'chatlist',
					extra: {
						newmsg: msg,
						type: 'send'
					}
				})
				//通知红包发送成功关闭页面
				if (msg.msgType == 'redBag') {
					api.sendEvent({
						name: 'redBagSuccess',
					})
				}
			});
		});

		//好友聊天 接收
		api.addEventListener({
			name: 'getfirendchat'
		}, function (ret, err) {
			// console.log(JSON.stringify(ret.value) + '好友聊天接收');
			var msg = ret.value.msg;
				msg.send_at=Date.parse(new Date()) / 1000;
			//入库
			// console.log('好友聊天接收入库id' + msg.sender);
			dbModule.pushMessage(msg.sender, msg);

			//通知 渲染
			api.sendEvent({
				name: 'getSuccess',
				extra: {
					msg: ret.value.msg
				}
			})
			//会话列表消息数量 本地存储 =>打开聊天页面清除
			if (Number(localStorage.getItem('chat' + msg.sender)) >= 1) {
				localStorage.setItem('chat' + msg.sender, Number(localStorage.getItem('chat' + msg.sender)) + 1);
			} else {
				localStorage.setItem('chat' + msg.sender, 1);
			}
			//通知 会话列表
			api.sendEvent({
				name: 'chatlist',
				extra: {
					newmsg: msg,
					type: 'get'
				}
			})


		});


		//群聊天 发送
		api.addEventListener({
			name: 'sendgroupchat'
		}, function (ret, err) {
			var msg = groupMsg(ret.value);

			Mysocket.write(msg, function () {//信息发送成功
				// console.log(JSON.stringify(msg) + '群聊天发送成功');

				//通知红包发送成功关闭页面
				if (msg.msgType == 'redBag') {
					api.sendEvent({
						name: 'redBagSuccess',
					})
				}
			});
		});
		//群聊天 接收
		api.addEventListener({
			name: 'getgroupchat'
		}, function (ret, err) {
			// console.warn(JSON.stringify(ret.value) + '群聊天接收');
			var msg = ret.value.msg;
			//通知 渲染
			api.sendEvent({
				name: 'getSuccess2',
				extra: {
					msg: msg
				}
			})

			//群会话列表及消息数量 本地存储 =>打开/关闭聊天页面清除消息
			if (localStorage.getItem('group' + msg.target_id)) {
				var group = JSON.parse(localStorage.getItem('group' + msg.target_id));
				group["content"] = msg.content;
				group["msgType"] = msg.msgType;
				group["newNum"] = Number(group["newNum"]) + 1;
				localStorage.setItem('group' + msg.target_id, JSON.stringify(group));
			} else {
				var group = {
					"group_id": msg.group_id,
					"target_id": msg.target_id,
					"group_name": msg.group_name,
					"group_head": msg.group_head,
					"msgType": msg.msgType,
					"content": msg.content,
					"newNum": 0
				}
				localStorage.setItem('group' + msg.target_id, JSON.stringify(group));
			}

			//通知会话列表
			api.sendEvent({
				name: 'grouplist',
				extra: {
					newmsg: msg,
				}
			})

		});

		//直播间 发送
		api.addEventListener({
			name: 'sendlivechat'
		}, function (ret, err) {
			var msg = liveMsg(ret.value);

			Mysocket.write(msg, function () {//信息发送成功
				// console.log(JSON.stringify(msg) + '直播间发送成功');
				//通知红包发送成功关闭页面
				if (msg.msgType == 'redBag') {
					api.sendEvent({
						name: 'redBagSuccess',
					})
				}
			});
		});

		//直播间 接收
		api.addEventListener({
			name: 'getlivechat'
		}, function (ret, err) {
			var msg = ret.value.msg;
			// console.log(JSON.stringify(msg) + '直播间接收');
			//通知 渲染
			api.sendEvent({
				name: 'getSuccess3',
				extra: {
					msg: msg
				}
			})
		});

		//被拉入群通知  被踢出群通知  红包被领取通知
		api.addEventListener({
			name: 'group_inout'
		}, function (ret, err) {
			var msg=privateMsg(ret.value.msg);
			Mysocket.write(msg, function () {//信息发送成功

			});
		});


		//语言切换
		api.addEventListener({
			name: 'langue'
		}, function (ret, err) {
			if (ret.value.font) {
				vm.fontlist = ret.value.font;
			}
		});

	};

	//单聊类型发送格式
	function privateMsg(msg) {
		if (msg.target_id == '' || msg.msgType == '') {
			alert('privateMsg error');
			return;
		}
		return {
			"type": "privateMsg",
			"target_id": msg.target_id,
			"sender": Mysocket.myself.id,
			"sender_nick": Mysocket.myself.nick,
			"sender_head": Mysocket.myself.head,
			"msgType": msg.msgType,//类型
			"content": msg.content || "",
			"send_at": Date.parse(new Date()) / 1000
		}
	}

	//群聊类型发送格式
	function groupMsg(msg) {
		if (msg.target_id == '' || msg.group_id == '' || msg.msgType == '') {
			alert('groupMsg error');
			return;
		}
		return {
			"type": "groupMsg",
			"target_id": msg.target_id,
			"sender": Mysocket.myself.id,
			"sender_nick": Mysocket.myself.nick,
			"sender_head": Mysocket.myself.head,
			"group_id": msg.group_id,//群标识
			"group_name": msg.group_name,//群昵称
			"group_head": msg.group_head,//群头像
			"msgType": msg.msgType,//类型
			"content": msg.content || "",
			"send_at": Date.parse(new Date()) / 1000
		}
	}

	//直播间类型发送格式
	function liveMsg(msg) {
		if (msg.msgType == '') {
			alert('liveMsg error');
			return;
		}
		var obj = {
			"type": "roomMsg",
			"sender": Mysocket.myself.id,//发送人
			"nick": Mysocket.myself.nick,
			"head": Mysocket.myself.head,
			"msgType": msg.msgType,//类型
			"content": msg.content || "",
			"voice_key": Date.parse(new Date()) / 1000
		}
		if (msg.msgType != 'voice') {
			delete obj['voice_key'];
		}
		return obj;
	}

	/*--------------------------*/

	//获取header
	function getCheckVal(success) {
		var url = BASE_URL + 'index.php/index/Index/getCheckVal';
		ajax(url, null, function (ret) {
			if (ret.code == 0) {
				localStorage.setItem('lodeval', ret.data);
				success && success();
			} else {
				api.toast({
					msg: ret.msg,
					duration: 2000,
					location: 'bottom'
				});
			}
		});
	}

	//已经登录
	function oldogin(success) {
		if (localStorage.getItem('account') && localStorage.getItem('pwd')) {
			vm.u_name = localStorage.getItem('account');
			vm.u_password = localStorage.getItem('pwd');
			success && success();
		}
	}

	//登录
	function logins(success) {
		var url = BASE_URL + 'index.php/api/Login/in';
		ajax(url, {
			account: vm.u_name,
			pwd: vm.u_password
		}, function (ret) {
			// console.log(JSON.stringify(ret))
			if (ret.code == 0) {
				localStorage.setItem("account", vm.u_name);
				localStorage.setItem("pwd", vm.u_password);
				localStorage.setItem("myselftoken", ret.data.token);
				api.toast({
					msg: font.login_success,
					duration: 2000,
					location: 'bottom'
				});
				api.openWin({
					name: 'index_footer',
					url: './html/index_footer.html'
				});
				success && success();
			} else {
				api.toast({
					msg: ret.msg,
					duration: 2000,
					location: 'bottom'
				});
			}
		});
	}

	//取得socket的token  赋值 Mysocket.SocketAuth
	function getSocketAuth(success) {
		var url = BASE_URL + 'index.php/api/User/getSocketAuth';
		ajax(url, null, function (ret) {
			// console.log(JSON.stringify(ret)+'');
			if (ret.code == 0) {
				//socket token 不存在
				if (ret.data == '') {
					alert('socket token error');
					return;
				}
				Mysocket.SocketAuth = ret.data;
				success && success();
			} else {
				api.toast({
					msg: ret.msg,
					duration: 2000,
					location: 'bottom'
				});
			}
		});
	}

	//取得自己ID/昵称/头像(socket可能使用) 赋值 Mysocket.myself并缓存
	function getSelfInfo(success) {
		var url = BASE_URL + 'index.php/api/Sundry/getSelfInfo';
		ajax(url, null, function (ret) {
			// console.log(JSON.stringify(ret)+'取得自己ID/昵称/头像(socket可能使用)');
			if (ret.code == 0) {
				//自己ID/昵称/头像 不存在
				if (ret.data == '' || ret.data.id == '') {
					alert('get myselfinfo failed');
					return;
				}
				Mysocket.myself = ret.data;
				localStorage.setItem(localsave.myselfinfo, JSON.stringify(ret.data));
				success && success();
			} else {
				api.toast({
					msg: ret.msg,
					duration: 2000,
					location: 'bottom'
				});
			}
		});
	}

	// for(var i in font){
	// 	console.log('"'+i.toLocaleLowerCase()+'":"'+font[i]+'"')
	// }
</script>
</html>
